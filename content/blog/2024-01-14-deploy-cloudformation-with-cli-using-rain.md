---
author: Thomas Taylor
categories:
- cloud
date: '2024-01-14T11:35:35-05:00'
description: An easy guide for deploying CloudFormation templates using Rain, an AWS CLI tool for handling deployments.
tags:
- aws
- aws-cli
title: 'A guide for deploy cloudformation with CLI using Rain'
---

![put image alt here](images/replace.webp)

Last year, I [wrote a post][1] describing the difference between `aws cloudformation deploy` and `aws cloudformation create-stack`. I concluded that the easiest method for deploying CloudFormation templates was `cloudformation deploy` since it handled change sets on your behalf.

My opinion has changed; I discovered a [new tool named Rain][2] that is maintained by AWS

## What is Rain

For folks who have the need to deploy raw CloudFormation templates, `rain` is your hero. The tool brings you a lot of power:

1. Allows input parameters
2. Showcases real-time updates for stack deployments
3. Filters deployment logs sensibly
4. Provides the ability to generate CloudFormation templates via AI (using Amazon Bedrock)
5. Manipulates stack sets
6. Formats template files

And [many more features][3]! As a previous user of CloudFormation, this tool appears amazing.

## Installing Rain

There are a few options for installing Rain, but I'll use the `golang` install for this tutorial.

```shell
go install github.com/aws-cloudformation/rain/cmd/rain@latest
```

For MacOS users, `brew` is easy:

```shell
brew install rain
```

The remaining releases are [featured in their GitHub repository][4].

## Build CloudFormation stacks using Rain

The [build command][5] accepts a prompt parameter to generate CloudFormation templates. Let's try to use it for generating a CloudFormation template with a bucket.

```shell
rain build -p "A s3 bucket that is secure"
```

Output:

```yaml
AWSTemplateFormatVersion: 2010-09-09
Description: Create an S3 bucket

Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-secure-bucket
      AccessControl: Private
      VersioningConfiguration:
        Status: Enabled
```

Although the `AccessControl` is a legacy property, it's great that the template was generated on my behalf.

The `build` property will generate a skeleton for resources as well:

```shell
rain build AWS::Route53::CidrCollection
```

or 

```shell
rain build CidrCollection
```

This outputs a template with all the parameters and dummy `CHANGEME` values for a Route53 CIDR collection:

```yaml
AWSTemplateFormatVersion: "2010-09-09"

Description: Template generated by rain

Resources:
  MyCidrCollection:
    Type: AWS::Route53::CidrCollection
    Properties:
      Locations:
        - CidrList:
            - CHANGEME
          LocationName: CHANGEME
      Name: CHANGEME

Outputs:
  MyCidrCollectionArn:
    Value: !GetAtt MyCidrCollection.Arn

  MyCidrCollectionId:
    Value: !GetAtt MyCidrCollection.Id
```

If you prefer `json`, there's a flag for that:

```shell
rain build CidrCollection --json
```

If you supply the command an ambigious term like "collection", it provides you a warning:

```shell
rain build collection
```

Output:

```text
Ambiguous resource type 'collection'; could be any of:
  AWS::DevOpsGuru::ResourceCollection
  AWS::Location::GeofenceCollection
  AWS::OpenSearchServerless::Collection
  AWS::Rekognition::Collection
  AWS::Route53::CidrCollection
```

## Bootstrap using Rain

Before deploying stacks into an environment, let's run the bootstrap command:

```shell
rain bootstrap
```

Output:

```text
Rain needs to create an S3 bucket called 'rain-artifacts-012345678901-us-east-1'. Continue? (Y/n)
```

This command creates an artifacts bucket that `rain` references when deploying stacks. It has the following naming convention:

```text
rain-artifacts-{accountId}-{regionName}
```

## Deploying stacks using Rain

I will explore deploying various stack configurations with `rain`.

### Deploying an S3 bucket

Using the S3 template `rain build` generated, let's deploy it!

This is my current directory structure:

```text
project
└── s3.yml
```

This is the command I'll use:

```shell
rain deploy s3.yml s3-bucket-stack
```

If you `rain bootstrap` was not executed before deploying, it'll prompt you to do so.

After a failed deploy, I received the following message:

```text
CloudFormation will make the following changes:
Stack s3-bucket-stack:
  + AWS::S3::Bucket MyS3Bucket
Do you wish to continue? (Y/n)
Deploying template 's3.yml' as stack 's3-bucket-stack' in us-east-1.
Stack s3-bucket-stack: ROLLBACK_COMPLETE
Messages:
  - MyS3Bucket: Resource handler returned message: "my-secure-bucket already exists (Service: S3, Status Code: 0, Request ID: null)" (RequestToken: c4a528c1-2fa0-e75e-efb1-5cfacc2aebd6, HandlerErrorCode: AlreadyExists)
failed deploying stack 's3-bucket-stack'
```

Since S3 is a global service, the name `s3-bucket-stack` exists in another account. I modified the `BucketName` to be `how-wtf-rain-bucket` and issued the same command:

```text
Deleted existing, empty stack.
CloudFormation will make the following changes:
Stack s3-bucket-stack:
  + AWS::S3::Bucket MyS3Bucket
Do you wish to continue? (Y/n)
Deploying template 's3.yml' as stack 's3-bucket-stack' in us-east-1.
Stack s3-bucket-stack: CREATE_COMPLETE
Successfully deployed s3-bucket-stack
```

A couple of awesome things to note:

1. It handled the failure of the stack gracefully _and_ gave me the exact issue
2. I deployed again and it took care of _everything_

I am impressed by the output of the tool!

[1]: https://how.wtf/cloudformation-create-stack-vs-deploy-in-aws-cli.html
[2]: https://github.com/aws-cloudformation/rain
[3]: https://github.com/aws-cloudformation/rain?tab=readme-ov-file#key-features
[4]: https://github.com/aws-cloudformation/rain/releases
[5]: https://aws-cloudformation.github.io/rain/rain_build.html
